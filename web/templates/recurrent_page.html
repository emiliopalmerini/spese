{{ define "recurrent_page" }}
<!doctype html>
<html lang="it">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#10b981" />
    <title>Spese</title>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg" />
    <link rel="stylesheet" href="/static/style.css" />
    <script src="https://unpkg.com/htmx.org@1.9.12" defer></script>
  </head>
  <body class="theme-ink density-comfortable style-minimal">
    <header class="topbar">
      <div class="container topbar__inner">
        <div class="brand">Spese</div>
        <nav class="topbar__nav">
          <a href="/" class="nav-link">Spese</a>
          <a href="/recurrent" class="nav-link">Spese Ricorrenti</a>
        </nav>
      </div>
    </header>
    <main class="container page">
      {{ template "recurrent_content" . }}
    </main>
  </body>
</html>
{{ end }}

{{ define "recurrent_content" }}
  <div class="container">
    {{/* Header with navigation */}}
    <section class="page__section">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
        <h1 class="page__title" style="margin: 0;">Spese Ricorrenti</h1>
        <a href="/" class="btn btn-secondary">← Torna alle Spese</a>
      </div>
    </section>

    {{/* Main form section */}}
    <section class="page__section">
      <h2 class="section-title">Nuova Spesa Ricorrente</h2>
      
      <form id="recurrent-expense-form"
            class="form"
            hx-post="/recurrent/create"
            hx-target="#flash"
            hx-swap="innerHTML"
            hx-indicator=".indicator"
            hx-on::after-request="if(event.detail.successful) { this.reset(); document.getElementById('description').focus(); window.location.reload(); }">

        {{/* Date fields group */}}
        <div class="field-group">
          <div class="field field--half">
            <label for="start_date">Data Inizio</label>
            <input 
              type="date" 
              id="start_date" 
              name="start_date" 
              required
            />
          </div>

          <div class="field field--half">
            <label for="end_date">Data Fine (opzionale)</label>
            <input 
              type="date" 
              id="end_date" 
              name="end_date"
            />
          </div>
        </div>

        {{/* Repetition type field */}}
        <div class="field">
          <label for="repetition_type">Frequenza</label>
          <select id="repetition_type" name="repetition_type" required>
            <option value="">Seleziona frequenza</option>
            <option value="daily">Giornaliera</option>
            <option value="weekly">Settimanale</option>
            <option value="monthly">Mensile</option>
            <option value="yearly">Annuale</option>
          </select>
        </div>

        {{/* Description field */}}
        <div class="field">
          <label for="description">Descrizione</label>
          <input 
            type="text" 
            id="description" 
            name="description" 
            required
            maxlength="200"
            placeholder="es. Abbonamento Netflix"
          />
        </div>

        {{/* Amount field */}}
        <div class="field">
          <label for="amount">Importo (€)</label>
          <input 
            type="number" 
            id="amount" 
            name="amount" 
            step="0.01" 
            min="0.01" 
            required
            placeholder="0.00"
          />
        </div>

        {{/* Category fields group */}}
        <div class="field-group">
          <div class="field field--half">
            <label for="primary">Categoria Primaria</label>
            <select 
              id="primary" 
              name="primary" 
              required
              hx-get="/api/categories/secondary"
              hx-trigger="change"
              hx-target="#secondary"
              hx-swap="innerHTML"
              hx-indicator="#category-loading"
            >
              <option value="">Seleziona categoria</option>
              {{ range .Categories }}
              <option value="{{ . }}">{{ . }}</option>
              {{ end }}
            </select>
          </div>

          <div class="field field--half">
            <label for="secondary">Categoria Secondaria</label>
            <select id="secondary" name="secondary" required>
              {{ if .Subcats }}
                {{ range .Subcats }}<option value="{{ . }}">{{ . }}</option>{{ end }}
              {{ else }}
                <option value="">Seleziona prima la categoria primaria</option>
              {{ end }}
            </select>
            <div id="category-loading" class="htmx-indicator" style="display: none; margin-top: 4px; font-size: 0.875rem; color: #6b7280;">
              Caricamento sottocategorie...
            </div>
          </div>
        </div>

        {{/* Flash messages area */}}
        <div id="flash" class="flash" aria-live="polite"></div>

        {{/* Submit button and loading indicator */}}
        <div class="actions">
          <button class="btn btn-primary btn--block" type="submit">Crea Spesa Ricorrente</button>
          <div class="indicator htmx-indicator" aria-hidden="true">
            <span class="spinner"></span>
            <span>Salvataggio in corso…</span>
          </div>
        </div>
      </form>
    </section>

    {{/* List of recurrent expenses */}}
    <section class="page__section">
      <h2 class="section-title">Spese Ricorrenti Attive</h2>
      
      {{ if .Expenses }}
      <div class="expenses-list">
        <table class="data-table">
          <thead>
            <tr>
              <th>Descrizione</th>
              <th>Importo</th>
              <th>Frequenza</th>
              <th>Data Inizio</th>
              <th>Data Fine</th>
              <th>Categoria</th>
              <th>Azioni</th>
            </tr>
          </thead>
          <tbody>
            {{ range .Expenses }}
            <tr class="expense-row">
              <td class="expense-description">{{ .Description }}</td>
              <td class="expense-amount">€ {{ printf "%.2f" (divFloat .Amount.Cents 100) }}</td>
              <td class="expense-frequency">
                {{ if eq .Every "daily" }}Giornaliera{{ end }}
                {{ if eq .Every "weekly" }}Settimanale{{ end }}
                {{ if eq .Every "monthly" }}Mensile{{ end }}
                {{ if eq .Every "yearly" }}Annuale{{ end }}
              </td>
              <td class="expense-date">{{ formatDate .StartDate.Day .StartDate.Month .StartDate.Year }}</td>
              <td class="expense-date">
                {{ if .EndDate.Year }}
                  {{ formatDate .EndDate.Month .EndDate.Day .EndDate.Year }}
                {{ else }}
                  <span class="text-muted">-</span>
                {{ end }}
              </td>
              <td class="expense-category">
                <span class="category-badge">{{ .Primary }}</span>
                <span class="subcategory-badge">{{ .Secondary }}</span>
              </td>
              <td class="expense-actions">
                <button 
                  class="btn btn-sm btn-secondary"
                  onclick="alert('Funzionalità di modifica in sviluppo')"
                  title="Modifica spesa ricorrente"
                >
                  Modifica
                </button>
                <button 
                  class="btn btn-sm btn-danger"
                  hx-post="/recurrent/delete"
                  hx-vals='{"id": "1"}'
                  hx-confirm="Sei sicuro di voler eliminare questa spesa ricorrente?"
                  hx-target="closest tr"
                  hx-swap="outerHTML"
                  title="Elimina spesa ricorrente"
                >
                  Elimina
                </button>
              </td>
            </tr>
            {{ end }}
          </tbody>
        </table>
      </div>
      {{ else }}
      <div class="empty-state">
        <p>Nessuna spesa ricorrente configurata.</p>
        <p class="text-muted">Aggiungi la tua prima spesa ricorrente usando il form sopra.</p>
      </div>
      {{ end }}
    </section>
  </div>
{{ end }}