{{ define "index_page" }}
<!doctype html>
<html lang="it">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#10b981" />
    <title>Spese</title>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg" />
    <link rel="stylesheet" href="/static/style.css" />
    <script src="https://unpkg.com/htmx.org@1.9.12" defer></script>
  </head>
  <body class="theme-ink density-comfortable style-minimal">
    <header class="topbar">
      <div class="container topbar__inner">
        <div class="brand">Spese</div>
        <nav class="topbar__nav">
          <a href="/" class="nav-link">Spese</a>
          <a href="/recurrent" class="nav-link">Spese Ricorrenti</a>
        </nav>
      </div>
    </header>
    <main class="container page">
      {{ template "index_content" . }}
    </main>
  </body>
</html>
{{ end }}

{{ define "index_content" }}
  <div class="container">
    {{/* Main expense form section */}}
    <section class="page__section">
      <h1 class="page__title">Registra Spesa</h1>
      
      <form id="expense-form"
            class="form"
            hx-post="/expenses"
            hx-target="#flash"
            hx-swap="innerHTML"
            hx-indicator=".indicator"
            hx-on::after-request="if(event.detail.successful) { this.reset(); document.getElementById('description').focus(); }">

        {{/* Date fields group */}}
        <div class="field-group">
          <div class="field field--half">
            <label for="day">Giorno</label>
            <input id="day" type="number" name="day" min="1" max="31" value="{{ .Day }}" required />
          </div>

          <div class="field field--half">
            <label for="month">Mese</label>
            <input id="month" type="number" name="month" min="1" max="12" value="{{ .Month }}" required />
          </div>
        </div>

        {{/* Description field */}}
        <div class="field">
          <label for="description">Descrizione</label>
          <input id="description" type="text" name="description" maxlength="200" placeholder="es. Supermercato" required />
        </div>

        {{/* Amount field */}}
        <div class="field">
          <label for="amount">Importo (€)</label>
          <input id="amount" type="number" name="amount" step="0.01" min="0.01" placeholder="0.00" required />
        </div>

        {{/* Category fields group */}}
        <div class="field-group">
          <div class="field field--half">
            <label for="primary">Categoria Primaria</label>
            <select id="primary" name="primary" required
                    hx-get="/api/categories/secondary"
                    hx-trigger="change"
                    hx-target="#secondary"
                    hx-swap="innerHTML"
                    hx-indicator="#category-loading">
              <option value="">Seleziona categoria</option>
              {{ range .Categories }}<option value="{{ . }}">{{ . }}</option>{{ end }}
            </select>
          </div>

          <div class="field field--half">
            <label for="secondary">Categoria Secondaria</label>
            <select id="secondary" name="secondary" required>
              {{/* If we have legacy subcategories (for non-SQLite adapters), show them */}}
              {{ if .Subcats }}
                {{ range .Subcats }}<option value="{{ . }}">{{ . }}</option>{{ end }}
              {{ else }}
                <option value="">Seleziona prima la categoria primaria</option>
              {{ end }}
            </select>
            <div id="category-loading" class="htmx-indicator" style="display: none; margin-top: 4px; font-size: 0.875rem; color: #6b7280;">
              Caricamento sottocategorie...
            </div>
          </div>
        </div>

        {{/* Flash messages area */}}
        <div id="flash" class="flash" aria-live="polite"></div>

        {{/* Submit button and loading indicator */}}
        <div class="actions">
          <button class="btn btn-primary btn--block" type="submit">Aggiungi Spesa</button>
          <div class="indicator htmx-indicator" aria-hidden="true">
            <span class="spinner"></span>
            <span>Salvataggio in corso…</span>
          </div>
        </div>
      </form>
    </section>

    {{/* Month overview section that loads via HTMX */}}
    <section class="page__section">
      <div id="month-overview" 
           hx-get="/ui/month-overview" 
           hx-trigger="load, expense:created from:body, expense:deleted from:body"
           hx-target="#month-overview" 
           hx-swap="outerHTML">
        <div class="placeholder">Caricamento panoramica mensile…</div>
      </div>
    </section>
  </div>
{{ end }}