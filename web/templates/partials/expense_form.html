{{/*
  Expense form - redesigned for better UX
  Amount-first, single date, combined category selector
*/}}
{{ define "expense_form" }}
<form id="expense-form"
      class="form"
      hx-post="/expenses"
      hx-target="#flash"
      hx-swap="innerHTML"
      hx-indicator=".indicator"
      x-data="expenseForm()"
      x-init="init()">

  {{/* Amount - big and prominent */}}
  <div class="field field--amount">
    <label for="amount">Importo</label>
    <div class="amount-input-wrapper">
      <span class="amount-currency">€</span>
      <input
        id="amount"
        type="text"
        inputmode="decimal"
        name="amount"
        placeholder="0,00"
        required
        autocomplete="off"
        x-ref="amountInput"
        @input="formatAmount($event)"
      />
    </div>
  </div>

  {{/* Description */}}
  <div class="field">
    <label for="description">Descrizione</label>
    <input
      id="description"
      type="text"
      name="description"
      maxlength="200"
      placeholder="es. Supermercato"
      required
    />
  </div>

  {{/* Date */}}
  <div class="field">
    <label for="date">Data</label>
    <input
      id="date"
      type="date"
      name="date"
      x-model="selectedDate"
      required
    />
    {{/* Hidden fields for backward compatibility */}}
    <input type="hidden" name="day" :value="selectedDay" />
    <input type="hidden" name="month" :value="selectedMonth" />
  </div>

  {{/* Category selector with Alpine.js */}}
  <div class="field" x-show="categories.length > 0">
    <label>Categoria</label>
    <div class="category-picker">
      {{/* Primary category buttons */}}
      <div class="category-chips">
        <template x-for="cat in categories" :key="cat.primary">
          <button
            type="button"
            class="category-chip"
            :class="{ 'active': selectedPrimary === cat.primary }"
            @click="selectPrimary(cat.primary)"
            x-text="cat.primary"
          ></button>
        </template>
      </div>

      {{/* Secondary category buttons - shown after primary selection */}}
      <div class="subcategory-section" x-show="selectedPrimary && currentSecondaries.length > 0" x-cloak>
        <div class="subcategory-chips">
          <template x-for="sub in currentSecondaries" :key="sub">
            <button
              type="button"
              class="category-chip category-chip--secondary"
              :class="{ 'active': selectedSecondary === sub }"
              @click="selectSecondary(sub)"
              x-text="sub"
            ></button>
          </template>
        </div>
      </div>
    </div>
    {{/* Hidden inputs for form submission */}}
    <input type="hidden" name="primary" :value="selectedPrimary" required />
    <input type="hidden" name="secondary" :value="selectedSecondary" required />
  </div>

  {{/* Loading state for categories */}}
  <div class="field" x-show="loading">
    <div class="placeholder">Caricamento categorie...</div>
  </div>

  {{/* Flash messages */}}
  <div id="flash"></div>

  {{/* Submit button */}}
  <div class="actions">
    <button
      class="btn btn-primary btn--block"
      type="submit"
      :disabled="!isValid"
    >
      Aggiungi Spesa
    </button>
    {{ template "loading_indicator" (dict "Text" "Salvataggio in corso…") }}
  </div>
</form>
{{ end }}
