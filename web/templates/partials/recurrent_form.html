{{/*
  Recurrent expense form - redesigned for better UX
  Amount-first, frequency chips, category chips
*/}}
{{ define "recurrent_form" }}
<form id="recurrent-expense-form"
      class="form"
      hx-post="/recurrent/create"
      hx-target="#flash"
      hx-swap="innerHTML"
      hx-indicator=".indicator"
      x-data="recurrentForm()"
      x-init="init()">

  {{/* Amount - big and prominent */}}
  <div class="field field--amount">
    <label for="amount">Importo</label>
    <div class="amount-input-wrapper">
      <span class="amount-currency">€</span>
      <input
        id="amount"
        type="text"
        inputmode="decimal"
        name="amount"
        placeholder="0,00"
        required
        autocomplete="off"
        x-ref="amountInput"
        @input="formatAmount($event)"
      />
    </div>
  </div>

  {{/* Description */}}
  <div class="field">
    <label for="description">Descrizione</label>
    <input
      id="description"
      type="text"
      name="description"
      maxlength="200"
      placeholder="es. Abbonamento Netflix"
      required
    />
  </div>

  {{/* Date fields */}}
  <div class="field-group">
    <div class="field field--half">
      <label for="start_date">Data inizio</label>
      <input
        id="start_date"
        type="date"
        name="start_date"
        required
      />
    </div>
    <div class="field field--half">
      <label for="end_date">Data fine (opz.)</label>
      <input
        id="end_date"
        type="date"
        name="end_date"
      />
    </div>
  </div>

  {{/* Frequency chips */}}
  <div class="field">
    <label>Frequenza</label>
    <div class="category-chips">
      <template x-for="freq in frequencies" :key="freq.value">
        <button
          type="button"
          class="category-chip"
          :class="{ 'active': selectedFrequency === freq.value }"
          @click="selectFrequency(freq.value)"
          x-text="freq.label"
        ></button>
      </template>
    </div>
    <input type="hidden" name="repetition_type" :value="selectedFrequency" required />
  </div>

  {{/* Category chips */}}
  <div class="field" x-show="categories.length > 0">
    <label>Categoria</label>
    <div class="category-picker">
      <div class="category-chips">
        <template x-for="cat in categories" :key="cat.primary">
          <button
            type="button"
            class="category-chip"
            :class="{ 'active': selectedPrimary === cat.primary }"
            @click="selectPrimary(cat.primary)"
            x-text="cat.primary"
          ></button>
        </template>
      </div>

      <div class="subcategory-section" x-show="selectedPrimary && currentSecondaries.length > 0" x-cloak>
        <div class="subcategory-chips">
          <template x-for="sub in currentSecondaries" :key="sub">
            <button
              type="button"
              class="category-chip category-chip--secondary"
              :class="{ 'active': selectedSecondary === sub }"
              @click="selectSecondary(sub)"
              x-text="sub"
            ></button>
          </template>
        </div>
      </div>
    </div>
    <input type="hidden" name="primary" :value="selectedPrimary" required />
    <input type="hidden" name="secondary" :value="selectedSecondary" required />
  </div>

  {{/* Loading state */}}
  <div class="field" x-show="loading">
    <div class="placeholder">Caricamento categorie...</div>
  </div>

  {{/* Flash messages */}}
  <div id="flash"></div>

  {{/* Submit button */}}
  <div class="actions">
    <button
      class="btn btn-primary btn--block"
      type="submit"
      :disabled="!isValid"
    >
      Aggiungi Spesa Ricorrente
    </button>
    {{ template "loading_indicator" (dict "Text" "Salvataggio in corso…") }}
  </div>
</form>
{{ end }}
