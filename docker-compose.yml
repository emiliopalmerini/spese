services:
  # RabbitMQ message broker for AMQP
  rabbitmq:
    image: rabbitmq:3.13-management
    container_name: spese-rabbitmq
    ports:
      - "5672:5672"   # AMQP port
      - "15672:15672" # Management UI
    environment:
      RABBITMQ_DEFAULT_USER: admin
      RABBITMQ_DEFAULT_PASS: admin
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    healthcheck:
      test: ["CMD", "rabbitmqctl", "status"]
      interval: 30s
      timeout: 10s
      retries: 5

  # OAuth initialization service (run once to get token)
  oauth-init:
    build: .
    image: spese:dev
    container_name: spese-oauth-init
    env_file:
      - .env
    ports:
      - "${OAUTH_REDIRECT_PORT:-8084}:${OAUTH_REDIRECT_PORT:-8085}"
    environment:
      - OAUTH_REDIRECT_PORT=${OAUTH_REDIRECT_PORT:-8085}
      # Ensure a sensible default path inside the container for token.json
      - GOOGLE_OAUTH_TOKEN_FILE=${GOOGLE_OAUTH_TOKEN_FILE:-/secrets/token.json}
    volumes:
      # Mount full configs dir for flexibility and also bind the specific client.json
      - ./configs:/configs:ro
      - ./configs/client.json:${GOOGLE_OAUTH_CLIENT_FILE:-/client.json}:ro
      - ./.secrets:/secrets
    command: go run ./cmd/oauth-init
    profiles: ["oauth"] # Only run when explicitly requested

  spese:
    build: .
    image: spese:dev
    container_name: spese
    env_file:
      - .env
    ports:
      - "${PORT:-8081}:8081"
    environment:
      - PORT=${PORT:-8081}
      - BASE_URL=${BASE_URL:-http://localhost:${PORT:-8081}}
      - DATA_BACKEND=${DATA_BACKEND:-sqlite}
      - SQLITE_DB_PATH=/data/spese.db
      - AMQP_URL=amqp://admin:admin@rabbitmq:5672/
      - AMQP_EXCHANGE=spese
      - AMQP_QUEUE=sync_expenses
      # OAuth: choose file- or json-based (file requires mounting volume)
      # Values from .env are injected via env_file; uncomment below only to override
      # - GOOGLE_OAUTH_CLIENT_JSON=${GOOGLE_OAUTH_CLIENT_JSON:-}
      # - GOOGLE_OAUTH_TOKEN_JSON=${GOOGLE_OAUTH_TOKEN_JSON:-}
    volumes:
      - ./configs/client.json:${GOOGLE_OAUTH_CLIENT_FILE:-/client.json}:ro
      - ./.secrets:/secrets:ro
      - spese_data:/data
    depends_on:
      rabbitmq:
        condition: service_healthy
    restart: unless-stopped

  # Background worker for syncing to Google Sheets
  spese-worker:
    build: .
    image: spese:dev
    container_name: spese-worker
    env_file:
      - .env
    environment:
      - DATA_BACKEND=sqlite
      - SQLITE_DB_PATH=/data/spese.db
      - AMQP_URL=amqp://admin:admin@rabbitmq:5672/
      - AMQP_EXCHANGE=spese
      - AMQP_QUEUE=sync_expenses
      - SYNC_BATCH_SIZE=${SYNC_BATCH_SIZE:-10}
      - SYNC_INTERVAL=${SYNC_INTERVAL:-30s}
      # OAuth credentials for Google Sheets access
      # - GOOGLE_OAUTH_CLIENT_JSON=${GOOGLE_OAUTH_CLIENT_JSON:-}
      # - GOOGLE_OAUTH_TOKEN_JSON=${GOOGLE_OAUTH_TOKEN_JSON:-}
    volumes:
      - ./configs/client.json:${GOOGLE_OAUTH_CLIENT_FILE:-/client.json}:ro
      - ./.secrets:/secrets:ro
      - spese_data:/data
    command: ["./bin/spese-worker"]
    depends_on:
      rabbitmq:
        condition: service_healthy
    restart: unless-stopped

volumes:
  rabbitmq_data:
  spese_data:
