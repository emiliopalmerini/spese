services:
  # OAuth initialization service (run once to get token)
  oauth-init:
    build: .
    image: spese:dev
    container_name: spese-oauth-init
    env_file:
      - .env
    ports:
      - "${OAUTH_REDIRECT_PORT:-8084}:${OAUTH_REDIRECT_PORT:-8085}"
    environment:
      - OAUTH_REDIRECT_PORT=${OAUTH_REDIRECT_PORT:-8085}
      # Ensure a sensible default path inside the container for token.json
      - GOOGLE_OAUTH_TOKEN_FILE=${GOOGLE_OAUTH_TOKEN_FILE:-/secrets/token.json}
    volumes:
      # Mount full configs dir for flexibility and also bind the specific client.json
      - ./configs:/configs:ro
      - ./configs/client.json:${GOOGLE_OAUTH_CLIENT_FILE:-/client.json}:ro
      - ./.secrets:/secrets
    command: go run ./cmd/oauth-init
    profiles: ["oauth"] # Only run when explicitly requested

  spese:
    build: .
    image: spese:dev
    container_name: spese
    env_file:
      - .env
    ports:
      - "${PORT:-8081}:8081"
    environment:
      - PORT=${PORT:-8081}
      - BASE_URL=${BASE_URL:-http://localhost:${PORT:-8081}}
      - DATA_BACKEND=${DATA_BACKEND:-memory}
      # OAuth: choose file- or json-based (file requires mounting volume)
      # Values from .env are injected via env_file; uncomment below only to override
      # - GOOGLE_OAUTH_CLIENT_JSON=${GOOGLE_OAUTH_CLIENT_JSON:-}
      # - GOOGLE_OAUTH_TOKEN_JSON=${GOOGLE_OAUTH_TOKEN_JSON:-}
    # Uncomment volumes below if using file-based OAuth credentials inside container
    volumes:
      - ./configs/client.json:${GOOGLE_OAUTH_CLIENT_FILE:-/client.json}:ro
      - ./.secrets:/secrets:ro
    restart: unless-stopped
