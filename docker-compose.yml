services:
  # OAuth initialization service (run once to get token)
  oauth-init:
    build: .
    image: spese:dev
    container_name: spese-oauth-init
    ports:
      - "${OAUTH_REDIRECT_PORT:-8085}:${OAUTH_REDIRECT_PORT:-8085}"
    environment:
      - OAUTH_REDIRECT_PORT=${OAUTH_REDIRECT_PORT:-8085}
      - GOOGLE_OAUTH_CLIENT_FILE=${GOOGLE_OAUTH_CLIENT_FILE:-}
      - GOOGLE_OAUTH_TOKEN_FILE=${GOOGLE_OAUTH_TOKEN_FILE:-/secrets/token.json}
      - GOOGLE_OAUTH_CLIENT_JSON=${GOOGLE_OAUTH_CLIENT_JSON:-}
    volumes:
      - ./configs:/configs:ro
      - ./.secrets:/secrets
    command: go run ./cmd/oauth-init
    profiles: ["oauth"] # Only run when explicitly requested

  spese:
    build: .
    image: spese:dev
    container_name: spese
    ports:
      - "${PORT:-8081}:8080"
    environment:
      - PORT=${PORT:-8080}
      - BASE_URL=${BASE_URL:-http://localhost:${PORT:-8080}}
      - DATA_BACKEND=${DATA_BACKEND:-memory}
      - GOOGLE_SPREADSHEET_ID=${GOOGLE_SPREADSHEET_ID}
      - GOOGLE_SHEET_NAME=${GOOGLE_SHEET_NAME:-2025 Expenses}
      - GOOGLE_CATEGORIES_SHEET_NAME=${GOOGLE_CATEGORIES_SHEET_NAME:-2025 Dashboard}
      - GOOGLE_SUBCATEGORIES_SHEET_NAME=${GOOGLE_SUBCATEGORIES_SHEET_NAME:-2025 Dashboard}
      # OAuth: choose file- or json-based (file requires mounting volume)
      - GOOGLE_OAUTH_CLIENT_FILE=${GOOGLE_OAUTH_CLIENT_FILE:-}
      - GOOGLE_OAUTH_TOKEN_FILE=${GOOGLE_OAUTH_TOKEN_FILE:-}
      # - GOOGLE_OAUTH_CLIENT_JSON=${GOOGLE_OAUTH_CLIENT_JSON:-}
      # - GOOGLE_OAUTH_TOKEN_JSON=${GOOGLE_OAUTH_TOKEN_JSON:-}
    # Uncomment volumes below if using file-based OAuth credentials inside container
    volumes:
      - ./configs/client.json:${GOOGLE_OAUTH_CLIENT_FILE:-/client.json}:ro
      - ./.secrets:/secrets:ro
    restart: unless-stopped
